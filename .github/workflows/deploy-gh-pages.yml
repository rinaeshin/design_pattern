name: Deploy Flutter Web to GitHub Pages (gh-pages)

on:
  push:
    branches:
      - release/design-pattern
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: gh-pages-deploy
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter Pub Get
        run: flutter pub get

      # í•„ìš” ì‹œ í…ŒìŠ¤íŠ¸ í™œì„±í™”
      # - name: Run Tests
      #   run: flutter test

      - name: Build Web (GitHub Pages base-href)
        run: |
          flutter --version
          flutter build web --release --base-href "/design_pattern/"

      # gh-pages ë¸Œëžœì¹˜ì— build/web ê²°ê³¼ë¥¼ ë£¨íŠ¸ë¡œ ë°°í¬
      - name: Deploy to gh-pages
        id: deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          # PATê°€ ì„¤ì •ë˜ì–´ ìžˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ GITHUB_TOKEN ì‚¬ìš©
          github_token: ${{ secrets.GH_PAT || secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: build/web
          force_orphan: true
          commit_message: "deploy: Flutter web (release/design-pattern) -> gh-pages"

      # main ë¸Œëžœì¹˜ README ìžë™ ì—…ë°ì´íŠ¸
      - name: Update main branch README
        env:
          DEPLOY_TIME: ${{ github.event.head_commit.timestamp }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # main ë¸Œëžœì¹˜ ì²´í¬ì•„ì›ƒ
          git fetch origin main
          git checkout main

          # README ì—…ë°ì´íŠ¸ (Last Deploy ì„¹ì…˜ ì¶”ê°€/ì—…ë°ì´íŠ¸)
          DEPLOY_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          DEPLOY_URL="https://rinaeshin.github.io/design_pattern/"
          SHORT_SHA=$(echo $COMMIT_SHA | cut -c1-7)

          # READMEì— Last Deploy ì„¹ì…˜ì´ ì—†ìœ¼ë©´ ì¶”ê°€, ìžˆìœ¼ë©´ ì—…ë°ì´íŠ¸
          if ! grep -q "## ðŸš€ Last Deploy" README.md; then
            # ì„¹ì…˜ ì¶”ê°€
            cat >> README.md << EOF

## ðŸš€ Last Deploy
- **Date**: ${DEPLOY_DATE}
- **Commit**: [\`${SHORT_SHA}\`](https://github.com/${{ github.repository }}/commit/${COMMIT_SHA})
- **Message**: ${COMMIT_MSG}
- **URL**: [${DEPLOY_URL}](${DEPLOY_URL})
EOF
          else
            # ê¸°ì¡´ ì„¹ì…˜ ì—…ë°ì´íŠ¸
            sed -i '/## ðŸš€ Last Deploy/,/^$/c\
## ðŸš€ Last Deploy\
- **Date**: '"${DEPLOY_DATE}"'\
- **Commit**: ['"${SHORT_SHA}"'](https://github.com/'"${{ github.repository }}"'/commit/'"${COMMIT_SHA}"')\
- **Message**: '"${COMMIT_MSG}"'\
- **URL**: ['"${DEPLOY_URL}"']('"${DEPLOY_URL}"')' README.md
          fi

          # ë³€ê²½ ì‚¬í•­ì´ ìžˆìœ¼ë©´ ì»¤ë°‹
          if ! git diff --quiet README.md; then
            git add README.md
            git commit -m "docs: update deploy info in README [skip ci]"
            git push origin main
          fi

      # ë°°í¬ ì„±ê³µ ì•Œë¦¼ (GitHub Actions Summary)
      - name: Deploy Success Notification
        if: success()
        run: |
          DEPLOY_URL="https://rinaeshin.github.io/design_pattern/"
          SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)

          cat >> $GITHUB_STEP_SUMMARY << EOF
          # âœ… Deploy Success!

          ## ðŸ“¦ Deployment Information
          - **Branch**: \`release/design-pattern\`
          - **Commit**: [\`${SHORT_SHA}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **Message**: ${{ github.event.head_commit.message }}
          - **Deploy Time**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")

          ## ðŸŒ Live URL
          ðŸ”— [${DEPLOY_URL}](${DEPLOY_URL})

          ## ðŸ“± QR Code
          ![QR Code](https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${DEPLOY_URL})

          ---
          *Automatically deployed to GitHub Pages (gh-pages branch)*
          EOF

      # ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
      - name: Deploy Failure Notification
        if: failure()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          # âŒ Deploy Failed

          ## Error Information
          - **Branch**: \`release/design-pattern\`
          - **Commit**: [\`${{ github.sha }}\`](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          - **Message**: ${{ github.event.head_commit.message }}

          Please check the workflow logs for details.
          EOF
